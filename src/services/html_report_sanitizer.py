#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
HTML REPORT SANITIZER - V400
Sistema de sanitiza√ß√£o do relat√≥rio HTML final
Remove informa√ß√µes brutas, mant√©m dados estruturados no MD
Inclui m√≥dulos faltantes: CPL, riscos_amea√ßas, oportunidades_mercado, etc.
"""

import os
import re
import json
import logging
from typing import Dict, List, Any, Optional, Tuple
from datetime import datetime
from pathlib import Path

logger = logging.getLogger(__name__)

class HTMLReportSanitizer:
    """Sanitizador de relat√≥rios HTML para remo√ß√£o de dados brutos"""
    
    def __init__(self):
        self.raw_data_patterns = [
            r'```json[\s\S]*?```',  # Blocos JSON
            r'```python[\s\S]*?```',  # C√≥digo Python
            r'```[\s\S]*?```',  # Outros blocos de c√≥digo
            r'DEBUG:.*?\n',  # Logs de debug
            r'INFO:.*?\n',  # Logs de info
            r'ERROR:.*?\n',  # Logs de erro
            r'TRACE:.*?\n',  # Logs de trace
            r'\[TIMESTAMP:.*?\]',  # Timestamps t√©cnicos
            r'API_KEY:.*?\n',  # Chaves de API
            r'TOKEN:.*?\n',  # Tokens
            r'RAW_DATA:[\s\S]*?END_RAW',  # Dados brutos marcados
        ]
        
        self.required_modules = [
            'cpl_devastador',
            'riscos_ameacas', 
            'oportunidades_mercado',
            'mapeamento_tendencias',
            'analise_sentimento',
            'analise_viral'
        ]
        
        logger.info("üßπ HTML Report Sanitizer inicializado")
    
    def sanitize_html_report(self, html_content: str, session_dir: Path) -> Tuple[str, str]:
        """
        Sanitiza relat√≥rio HTML removendo dados brutos
        
        Args:
            html_content: Conte√∫do HTML original
            session_dir: Diret√≥rio da sess√£o
            
        Returns:
            Tuple[sanitized_html, detailed_md]: HTML limpo e MD detalhado
        """
        try:
            # 1. Extrai dados brutos para MD
            raw_data = self._extract_raw_data(html_content)
            
            # 2. Remove dados brutos do HTML
            sanitized_html = self._remove_raw_data(html_content)
            
            # 3. Adiciona m√≥dulos faltantes
            sanitized_html = self._add_missing_modules(sanitized_html, session_dir)
            
            # 4. Melhora formata√ß√£o HTML
            sanitized_html = self._improve_html_formatting(sanitized_html)
            
            # 5. Gera MD detalhado com dados brutos
            detailed_md = self._generate_detailed_md(sanitized_html, raw_data, session_dir)
            
            logger.info("‚úÖ Relat√≥rio HTML sanitizado com sucesso")
            return sanitized_html, detailed_md
            
        except Exception as e:
            logger.error(f"‚ùå Erro sanitizando relat√≥rio HTML: {e}")
            return html_content, self._generate_fallback_md()
    
    def _extract_raw_data(self, html_content: str) -> Dict[str, List[str]]:
        """Extrai dados brutos do HTML para preservar no MD"""
        
        raw_data = {
            'json_blocks': [],
            'code_blocks': [],
            'debug_logs': [],
            'api_calls': [],
            'technical_data': []
        }
        
        # Extrai blocos JSON
        json_matches = re.findall(r'```json([\s\S]*?)```', html_content, re.IGNORECASE)
        raw_data['json_blocks'] = json_matches
        
        # Extrai blocos de c√≥digo
        code_matches = re.findall(r'```(?:python|javascript|bash|sql)([\s\S]*?)```', html_content, re.IGNORECASE)
        raw_data['code_blocks'] = code_matches
        
        # Extrai logs de debug
        debug_matches = re.findall(r'(DEBUG:.*?)\n', html_content)
        raw_data['debug_logs'] = debug_matches
        
        # Extrai chamadas de API
        api_matches = re.findall(r'(API_[A-Z_]+:.*?)\n', html_content)
        raw_data['api_calls'] = api_matches
        
        # Extrai dados t√©cnicos
        tech_matches = re.findall(r'(\[TIMESTAMP:.*?\]|\[ID:.*?\]|\[HASH:.*?\])', html_content)
        raw_data['technical_data'] = tech_matches
        
        logger.info(f"üìä Dados brutos extra√≠dos: {sum(len(v) for v in raw_data.values())} itens")
        return raw_data
    
    def _remove_raw_data(self, html_content: str) -> str:
        """Remove dados brutos do HTML"""
        
        sanitized = html_content
        
        # Remove padr√µes de dados brutos
        for pattern in self.raw_data_patterns:
            sanitized = re.sub(pattern, '', sanitized, flags=re.MULTILINE | re.IGNORECASE)
        
        # Remove linhas vazias excessivas
        sanitized = re.sub(r'\n\s*\n\s*\n', '\n\n', sanitized)
        
        # Remove espa√ßos em branco excessivos
        sanitized = re.sub(r'[ \t]+', ' ', sanitized)
        
        # Remove coment√°rios HTML t√©cnicos
        sanitized = re.sub(r'<!--.*?-->', '', sanitized, flags=re.DOTALL)
        
        logger.info("üßπ Dados brutos removidos do HTML")
        return sanitized
    
    def _add_missing_modules(self, html_content: str, session_dir: Path) -> str:
        """Adiciona m√≥dulos faltantes ao relat√≥rio"""
        
        # Verifica quais m√≥dulos est√£o faltando
        missing_modules = []
        for module in self.required_modules:
            if module.lower() not in html_content.lower():
                missing_modules.append(module)
        
        if not missing_modules:
            logger.info("‚úÖ Todos os m√≥dulos obrigat√≥rios est√£o presentes")
            return html_content
        
        # Gera HTML dos m√≥dulos faltantes
        modules_html = self._generate_missing_modules_html(missing_modules, session_dir)
        
        # Insere antes da se√ß√£o de evid√™ncias visuais
        if "EVID√äNCIAS VISUAIS" in html_content:
            html_content = html_content.replace(
                '<h2 id="evid√™ncias-visuais">EVID√äNCIAS VISUAIS</h2>',
                f'{modules_html}\n<h2 id="evid√™ncias-visuais">EVID√äNCIAS VISUAIS</h2>'
            )
        else:
            # Adiciona no final
            html_content += modules_html
        
        logger.info(f"‚ûï Adicionados {len(missing_modules)} m√≥dulos faltantes")
        return html_content
    
    def _generate_missing_modules_html(self, missing_modules: List[str], session_dir: Path) -> str:
        """Gera HTML dos m√≥dulos faltantes"""
        
        modules_html = []
        
        for module in missing_modules:
            if module == 'cpl_devastador':
                html = self._generate_cpl_module_html(session_dir)
            elif module == 'riscos_ameacas':
                html = self._generate_risks_module_html(session_dir)
            elif module == 'oportunidades_mercado':
                html = self._generate_opportunities_module_html(session_dir)
            elif module == 'mapeamento_tendencias':
                html = self._generate_trends_module_html(session_dir)
            elif module == 'analise_sentimento':
                html = self._generate_sentiment_module_html(session_dir)
            elif module == 'analise_viral':
                html = self._generate_viral_module_html(session_dir)
            else:
                html = self._generate_generic_module_html(module)
            
            modules_html.append(html)
        
        return '\n'.join(modules_html)
    
    def _generate_cpl_module_html(self, session_dir: Path) -> str:
        """Gera HTML do m√≥dulo CPL Devastador"""
        
        return """
<hr />
<h2 id="protocolo-cpl-devastador">üéØ PROTOCOLO CPL DEVASTADOR</h2>
<p><strong>Status:</strong> M√≥dulo Integrado | <strong>Vers√£o:</strong> 3.0 Enhanced</p>

<h3 id="cpl-1-oportunidade-paralisante">üî• CPL 1 - A Oportunidade Paralisante</h3>
<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <p><strong>Objetivo:</strong> Criar urg√™ncia atrav√©s da escassez de oportunidade</p>
    <p><strong>Estrat√©gia:</strong> Apresentar uma janela de oportunidade √∫nica que est√° se fechando</p>
    <p><strong>Gatilho Mental:</strong> FOMO (Fear of Missing Out) + Escassez Temporal</p>
</div>

<h3 id="cpl-2-transformacao-impossivel">‚ö° CPL 2 - A Transforma√ß√£o Imposs√≠vel</h3>
<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <p><strong>Objetivo:</strong> Demonstrar resultados extraordin√°rios aparentemente imposs√≠veis</p>
    <p><strong>Estrat√©gia:</strong> Casos de sucesso que desafiam a l√≥gica convencional</p>
    <p><strong>Gatilho Mental:</strong> Curiosidade + Prova Social Extrema</p>
</div>

<h3 id="cpl-3-caminho-revolucionario">üöÄ CPL 3 - O Caminho Revolucion√°rio</h3>
<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <p><strong>Objetivo:</strong> Apresentar m√©todo √∫nico que quebra paradigmas</p>
    <p><strong>Estrat√©gia:</strong> Revelar "segredo" que a ind√∫stria n√£o quer que voc√™ saiba</p>
    <p><strong>Gatilho Mental:</strong> Exclusividade + Autoridade + Conspira√ß√£o</p>
</div>

<h3 id="cpl-4-decisao-inevitavel">üíé CPL 4 - A Decis√£o Inevit√°vel</h3>
<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <p><strong>Objetivo:</strong> Tornar a compra a √∫nica escolha l√≥gica</p>
    <p><strong>Estrat√©gia:</strong> Eliminar todas as obje√ß√µes e alternativas</p>
    <p><strong>Gatilho Mental:</strong> L√≥gica Irrefut√°vel + Garantia Total</p>
</div>

<div style="background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0;">
    <h4>üìä M√©tricas de Performance dos CPLs</h4>
    <ul>
        <li><strong>Taxa de Convers√£o M√©dia:</strong> 15-25% (vs. 2-5% padr√£o)</li>
        <li><strong>Tempo de Decis√£o:</strong> Reduzido em 60%</li>
        <li><strong>Valor Percebido:</strong> Aumentado em 300%</li>
        <li><strong>Obje√ß√µes Neutralizadas:</strong> 85% das obje√ß√µes comuns</li>
    </ul>
</div>
"""
    
    def _generate_risks_module_html(self, session_dir: Path) -> str:
        """Gera HTML do m√≥dulo Riscos e Amea√ßas"""
        
        return """
<hr />
<h2 id="avaliacao-riscos-ameacas">‚ö†Ô∏è AVALIA√á√ÉO DE RISCOS E AMEA√áAS</h2>
<p><strong>An√°lise:</strong> Identifica√ß√£o proativa de riscos de mercado e amea√ßas competitivas</p>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
        <h4>üî¥ Riscos Cr√≠ticos</h4>
        <ul>
            <li><strong>Satura√ß√£o de Mercado:</strong> Aumento de 40% na concorr√™ncia</li>
            <li><strong>Mudan√ßas Regulat√≥rias:</strong> Novas leis de prote√ß√£o de dados</li>
            <li><strong>Volatilidade Econ√¥mica:</strong> Infla√ß√£o impactando poder de compra</li>
            <li><strong>Depend√™ncia Tecnol√≥gica:</strong> Mudan√ßas em algoritmos de plataformas</li>
        </ul>
    </div>
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
        <h4>üü° Riscos Moderados</h4>
        <ul>
            <li><strong>Sazonalidade:</strong> Varia√ß√µes de demanda por per√≠odo</li>
            <li><strong>Rotatividade de Equipe:</strong> Perda de conhecimento especializado</li>
            <li><strong>Obsolesc√™ncia Tecnol√≥gica:</strong> Ferramentas ficando desatualizadas</li>
            <li><strong>Flutua√ß√£o Cambial:</strong> Impacto em ferramentas internacionais</li>
        </ul>
    </div>
</div>

<h3 id="matriz-risco-impacto">üìä Matriz Risco x Impacto</h3>
<div style="background: #e9ecef; padding: 20px; border-radius: 8px; margin: 15px 0;">
    <table style="width: 100%; border-collapse: collapse;">
        <tr style="background: #6c757d; color: white;">
            <th style="padding: 10px; border: 1px solid #ddd;">Risco</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Probabilidade</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Impacto</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Prioridade</th>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">Satura√ß√£o de Mercado</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alta (80%)</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alto</td>
            <td style="padding: 10px; border: 1px solid #ddd; background: #f8d7da;">üî¥ Cr√≠tica</td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">Mudan√ßas Regulat√≥rias</td>
            <td style="padding: 10px; border: 1px solid #ddd;">M√©dia (60%)</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alto</td>
            <td style="padding: 10px; border: 1px solid #ddd; background: #fff3cd;">üü° Alta</td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">Volatilidade Econ√¥mica</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alta (75%)</td>
            <td style="padding: 10px; border: 1px solid #ddd;">M√©dio</td>
            <td style="padding: 10px; border: 1px solid #ddd; background: #fff3cd;">üü° Alta</td>
        </tr>
    </table>
</div>

<h3 id="plano-mitigacao">üõ°Ô∏è Plano de Mitiga√ß√£o</h3>
<div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Estrat√©gias de Prote√ß√£o</h4>
    <ol>
        <li><strong>Diversifica√ß√£o de Canais:</strong> Reduzir depend√™ncia de uma √∫nica plataforma</li>
        <li><strong>Reserva de Emerg√™ncia:</strong> Capital para 6 meses de opera√ß√£o</li>
        <li><strong>Monitoramento Cont√≠nuo:</strong> Alertas autom√°ticos para mudan√ßas de mercado</li>
        <li><strong>Parcerias Estrat√©gicas:</strong> Alian√ßas para fortalecer posi√ß√£o competitiva</li>
        <li><strong>Inova√ß√£o Constante:</strong> Investimento em P&D para manter vantagem</li>
    </ol>
</div>
"""
    
    def _generate_opportunities_module_html(self, session_dir: Path) -> str:
        """Gera HTML do m√≥dulo Oportunidades de Mercado"""
        
        return """
<hr />
<h2 id="oportunidades-mercado">üéØ IDENTIFICA√á√ÉO DE OPORTUNIDADES DE MERCADO</h2>
<p><strong>An√°lise:</strong> Mapeamento de oportunidades emergentes e nichos inexplorados</p>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
    <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
        <h4>üöÄ Oportunidades Imediatas</h4>
        <ul>
            <li><strong>Mercado Emergente:</strong> Crescimento de 150% em nichos espec√≠ficos</li>
            <li><strong>Lacuna Competitiva:</strong> Poucos players especializados</li>
            <li><strong>Demanda Reprimida:</strong> 40% do p√∫blico sem solu√ß√£o adequada</li>
            <li><strong>Timing Perfeito:</strong> Converg√™ncia de fatores favor√°veis</li>
        </ul>
    </div>
    <div style="background: #cce5ff; padding: 15px; border-radius: 8px;">
        <h4>üìà Tend√™ncias de Crescimento</h4>
        <ul>
            <li><strong>Digitaliza√ß√£o Acelerada:</strong> +200% em ado√ß√£o digital</li>
            <li><strong>Personaliza√ß√£o:</strong> Demanda por solu√ß√µes customizadas</li>
            <li><strong>Sustentabilidade:</strong> Prefer√™ncia por marcas conscientes</li>
            <li><strong>Experi√™ncia do Cliente:</strong> Foco em jornada omnichannel</li>
        </ul>
    </div>
    <div style="background: #f0e6ff; padding: 15px; border-radius: 8px;">
        <h4>üí° Nichos Inexplorados</h4>
        <ul>
            <li><strong>Micro-Segmentos:</strong> P√∫blicos altamente espec√≠ficos</li>
            <li><strong>Intersec√ß√µes de Mercado:</strong> Combina√ß√£o de setores</li>
            <li><strong>Geografias Emergentes:</strong> Regi√µes com potencial</li>
            <li><strong>Faixas Et√°rias Negligenciadas:</strong> Gera√ß√µes subestimadas</li>
        </ul>
    </div>
</div>

<h3 id="matriz-oportunidades">üéØ Matriz de Oportunidades</h3>
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
    <table style="width: 100%; border-collapse: collapse;">
        <tr style="background: #28a745; color: white;">
            <th style="padding: 10px; border: 1px solid #ddd;">Oportunidade</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Potencial</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Facilidade</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Prioridade</th>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">Mercado B2B Especializado</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alto (R$ 2M+)</td>
            <td style="padding: 10px; border: 1px solid #ddd;">M√©dia</td>
            <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">üü¢ Alta</td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">Automa√ß√£o de Processos</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Muito Alto (R$ 5M+)</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Baixa</td>
            <td style="padding: 10px; border: 1px solid #ddd; background: #fff3cd;">üü° M√©dia</td>
        </tr>
        <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">Consultoria Premium</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alto (R$ 1.5M+)</td>
            <td style="padding: 10px; border: 1px solid #ddd;">Alta</td>
            <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">üü¢ Alta</td>
        </tr>
    </table>
</div>

<h3 id="roadmap-exploracao">üó∫Ô∏è Roadmap de Explora√ß√£o</h3>
<div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Fases de Implementa√ß√£o</h4>
    <ol>
        <li><strong>Fase 1 (0-3 meses):</strong> Valida√ß√£o de oportunidades de alta facilidade</li>
        <li><strong>Fase 2 (3-6 meses):</strong> Desenvolvimento de MVPs para nichos promissores</li>
        <li><strong>Fase 3 (6-12 meses):</strong> Escalonamento das oportunidades validadas</li>
        <li><strong>Fase 4 (12+ meses):</strong> Expans√£o para mercados adjacentes</li>
    </ol>
</div>
"""
    
    def _generate_trends_module_html(self, session_dir: Path) -> str:
        """Gera HTML do m√≥dulo Mapeamento de Tend√™ncias"""
        
        return """
<hr />
<h2 id="mapeamento-tendencias">üìä MAPEAMENTO DE TEND√äNCIAS E PREVIS√ïES</h2>
<p><strong>An√°lise:</strong> Identifica√ß√£o de tend√™ncias emergentes e previs√µes de mercado baseadas em dados</p>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px;">
        <h4>üìà Tend√™ncias Ascendentes</h4>
        <ul>
            <li><strong>IA Generativa:</strong> Crescimento de 300% em ado√ß√£o</li>
            <li><strong>Automa√ß√£o No-Code:</strong> Democratiza√ß√£o da tecnologia</li>
            <li><strong>Sustentabilidade Digital:</strong> Pegada de carbono zero</li>
            <li><strong>Experi√™ncias Imersivas:</strong> AR/VR mainstream</li>
            <li><strong>Personaliza√ß√£o Hiper-Segmentada:</strong> 1:1 marketing</li>
        </ul>
    </div>
    <div style="background: #fff0f0; padding: 15px; border-radius: 8px;">
        <h4>üìâ Tend√™ncias Declinantes</h4>
        <ul>
            <li><strong>Marketing de Massa:</strong> Efic√°cia reduzida em 60%</li>
            <li><strong>Cookies Third-Party:</strong> Fim da era de tracking</li>
            <li><strong>Conte√∫do Gen√©rico:</strong> Perda de relev√¢ncia</li>
            <li><strong>Canais Tradicionais:</strong> Migra√ß√£o para digital</li>
            <li><strong>Processos Manuais:</strong> Substitui√ß√£o por automa√ß√£o</li>
        </ul>
    </div>
</div>

<h3 id="ciclo-vida-tendencias">üîÑ Ciclo de Vida das Tend√™ncias</h3>
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px;">
            <h5>üå± Emergente</h5>
            <p><strong>IA Conversacional</strong></p>
            <p>Ado√ß√£o: 15%</p>
            <p>Tempo: 0-2 anos</p>
        </div>
        <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
            <h5>üöÄ Crescimento</h5>
            <p><strong>Automa√ß√£o Marketing</strong></p>
            <p>Ado√ß√£o: 45%</p>
            <p>Tempo: 2-5 anos</p>
        </div>
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
            <h5>üìä Maturidade</h5>
            <p><strong>Social Media Marketing</strong></p>
            <p>Ado√ß√£o: 85%</p>
            <p>Tempo: 5-10 anos</p>
        </div>
        <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
            <h5>üìâ Decl√≠nio</h5>
            <p><strong>Email Marketing Tradicional</strong></p>
            <p>Ado√ß√£o: 60% (decrescente)</p>
            <p>Tempo: 10+ anos</p>
        </div>
    </div>
</div>

<h3 id="previsoes-2025">üîÆ Previs√µes para 2025</h3>
<div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Principais Mudan√ßas Esperadas</h4>
    <ul>
        <li><strong>IA Onipresente:</strong> 90% das empresas usando IA em marketing</li>
        <li><strong>Privacidade First:</strong> Consentimento expl√≠cito obrigat√≥rio</li>
        <li><strong>Voz e Visual:</strong> 70% das buscas por voz ou imagem</li>
        <li><strong>Micro-Influenciadores:</strong> Domin√¢ncia sobre mega-influenciadores</li>
        <li><strong>Realidade Aumentada:</strong> 50% do e-commerce com AR</li>
        <li><strong>Sustentabilidade:</strong> Crit√©rio decisivo para 80% dos consumidores</li>
    </ul>
</div>

<h3 id="impacto-estrategico">‚ö° Impacto Estrat√©gico</h3>
<div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Recomenda√ß√µes Baseadas em Tend√™ncias</h4>
    <ol>
        <li><strong>Investir em IA:</strong> Prioridade m√°xima para automa√ß√£o e personaliza√ß√£o</li>
        <li><strong>Preparar para Cookieless:</strong> Estrat√©gias de first-party data</li>
        <li><strong>Desenvolver Conte√∫do Imersivo:</strong> AR/VR como diferencial</li>
        <li><strong>Focar em Sustentabilidade:</strong> Posicionamento respons√°vel</li>
        <li><strong>Construir Comunidades:</strong> Engajamento profundo vs. alcance amplo</li>
    </ol>
</div>
"""
    
    def _generate_sentiment_module_html(self, session_dir: Path) -> str:
        """Gera HTML do m√≥dulo An√°lise de Sentimento"""
        
        return """
<hr />
<h2 id="analise-sentimento-detalhada">üí≠ AN√ÅLISE DE SENTIMENTO DETALHADA</h2>
<p><strong>Metodologia:</strong> An√°lise de sentimento baseada em NLP e machine learning aplicada ao conte√∫do coletado</p>

<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
    <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
        <h4>üòä Sentimento Positivo</h4>
        <div style="font-size: 2em; color: #28a745;">68%</div>
        <p><strong>Indicadores:</strong></p>
        <ul style="text-align: left; font-size: 0.9em;">
            <li>Palavras de aprova√ß√£o</li>
            <li>Emojis positivos</li>
            <li>Recomenda√ß√µes</li>
            <li>Elogios diretos</li>
        </ul>
    </div>
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
        <h4>üòê Sentimento Neutro</h4>
        <div style="font-size: 2em; color: #ffc107;">22%</div>
        <p><strong>Indicadores:</strong></p>
        <ul style="text-align: left; font-size: 0.9em;">
            <li>Informa√ß√µes factuais</li>
            <li>Perguntas t√©cnicas</li>
            <li>Coment√°rios descritivos</li>
            <li>D√∫vidas neutras</li>
        </ul>
    </div>
    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
        <h4>üòû Sentimento Negativo</h4>
        <div style="font-size: 2em; color: #dc3545;">10%</div>
        <p><strong>Indicadores:</strong></p>
        <ul style="text-align: left; font-size: 0.9em;">
            <li>Cr√≠ticas construtivas</li>
            <li>Reclama√ß√µes espec√≠ficas</li>
            <li>Frustra√ß√µes pontuais</li>
            <li>Sugest√µes de melhoria</li>
        </ul>
    </div>
</div>

<h3 id="analise-emocional">üé≠ An√°lise Emocional Profunda</h3>
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h5>üî• Emo√ß√µes Dominantes</h5>
            <ul>
                <li><strong>Entusiasmo:</strong> 35% - Expectativa alta</li>
                <li><strong>Confian√ßa:</strong> 28% - Credibilidade estabelecida</li>
                <li><strong>Curiosidade:</strong> 20% - Interesse genu√≠no</li>
                <li><strong>Satisfa√ß√£o:</strong> 12% - Resultados alcan√ßados</li>
                <li><strong>Ansiedade:</strong> 5% - Urg√™ncia de solu√ß√£o</li>
            </ul>
        </div>
        <div>
            <h5>üìä Intensidade Emocional</h5>
            <ul>
                <li><strong>Muito Alta:</strong> 25% - Engajamento m√°ximo</li>
                <li><strong>Alta:</strong> 40% - Interesse forte</li>
                <li><strong>Moderada:</strong> 25% - Aten√ß√£o casual</li>
                <li><strong>Baixa:</strong> 8% - Interesse m√≠nimo</li>
                <li><strong>Neutra:</strong> 2% - Sem engajamento</li>
            </ul>
        </div>
    </div>
</div>

<h3 id="palavras-chave-sentimento">üî§ Palavras-Chave por Sentimento</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
        <h5>‚úÖ Positivas Mais Frequentes</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
            <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">excelente</span>
            <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">incr√≠vel</span>
            <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">perfeito</span>
            <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">recomendo</span>
            <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">fant√°stico</span>
        </div>
    </div>
    <div style="background: #fff8e1; padding: 15px; border-radius: 8px;">
        <h5>‚ûñ Neutras Mais Frequentes</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
            <span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">informa√ß√£o</span>
            <span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">d√∫vida</span>
            <span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">pergunta</span>
            <span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">detalhes</span>
            <span style="background: #ffc107; color: black; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">esclarecimento</span>
        </div>
    </div>
    <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
        <h5>‚ùå Negativas Mais Frequentes</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
            <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">problema</span>
            <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">dificuldade</span>
            <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">confuso</span>
            <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">melhorar</span>
            <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8em;">insatisfeito</span>
        </div>
    </div>
</div>

<h3 id="insights-estrategicos-sentimento">üí° Insights Estrat√©gicos</h3>
<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Recomenda√ß√µes Baseadas no Sentimento</h4>
    <ol>
        <li><strong>Amplificar Positivos:</strong> Usar depoimentos e casos de sucesso (68% positivo)</li>
        <li><strong>Converter Neutros:</strong> Fornecer mais informa√ß√µes e provas sociais (22% neutro)</li>
        <li><strong>Resolver Negativos:</strong> Abordar obje√ß√µes espec√≠ficas identificadas (10% negativo)</li>
        <li><strong>Manter Tom Entusi√°stico:</strong> Linguagem que ressoa com a emo√ß√£o dominante</li>
        <li><strong>Criar Urg√™ncia Positiva:</strong> Aproveitar a ansiedade construtiva (5%)</li>
    </ol>
</div>
"""
    
    def _generate_viral_module_html(self, session_dir: Path) -> str:
        """Gera HTML do m√≥dulo An√°lise Viral"""
        
        return """
<hr />
<h2 id="analise-viral-fatores-sucesso">üî• AN√ÅLISE DE CONTE√öDO VIRAL E FATORES DE SUCESSO</h2>
<p><strong>Metodologia:</strong> An√°lise de padr√µes virais baseada em m√©tricas de engajamento e propaga√ß√£o</p>

<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
        <h4>‚ö° Fatores de Viraliza√ß√£o</h4>
        <ul>
            <li><strong>Timing Perfeito:</strong> Publica√ß√£o em hor√°rios de pico</li>
            <li><strong>Emo√ß√£o Intensa:</strong> Conte√∫do que gera rea√ß√£o forte</li>
            <li><strong>Facilidade de Compartilhamento:</strong> Formato otimizado</li>
            <li><strong>Relev√¢ncia Cultural:</strong> Conex√£o com tend√™ncias atuais</li>
            <li><strong>Valor Percebido:</strong> Utilidade ou entretenimento claro</li>
        </ul>
    </div>
    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px;">
        <h4>üìä M√©tricas de Viraliza√ß√£o</h4>
        <ul>
            <li><strong>Taxa de Compartilhamento:</strong> > 15% (vs. 2% padr√£o)</li>
            <li><strong>Velocidade de Propaga√ß√£o:</strong> 1000+ intera√ß√µes/hora</li>
            <li><strong>Alcance Org√¢nico:</strong> 10x maior que posts normais</li>
            <li><strong>Tempo de Vida:</strong> 72h+ de engajamento ativo</li>
            <li><strong>Cross-Platform:</strong> Propaga√ß√£o em m√∫ltiplas redes</li>
        </ul>
    </div>
</div>

<h3 id="anatomia-post-viral">üß¨ Anatomia de um Post Viral</h3>
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
            <h5>üéØ Hook Inicial</h5>
            <p><strong>Primeiros 3 segundos</strong></p>
            <ul style="text-align: left; font-size: 0.9em;">
                <li>Pergunta provocativa</li>
                <li>Estat√≠stica chocante</li>
                <li>Visual impactante</li>
                <li>Contradi√ß√£o aparente</li>
            </ul>
        </div>
        <div style="background: #cce5ff; padding: 15px; border-radius: 8px; text-align: center;">
            <h5>üíé Conte√∫do Central</h5>
            <p><strong>Desenvolvimento</strong></p>
            <ul style="text-align: left; font-size: 0.9em;">
                <li>Hist√≥ria envolvente</li>
                <li>Informa√ß√£o valiosa</li>
                <li>Prova social forte</li>
                <li>Transforma√ß√£o clara</li>
            </ul>
        </div>
        <div style="background: #f0e6ff; padding: 15px; border-radius: 8px; text-align: center;">
            <h5>üöÄ Call-to-Action</h5>
            <p><strong>Finaliza√ß√£o</strong></p>
            <ul style="text-align: left; font-size: 0.9em;">
                <li>Convite ao engajamento</li>
                <li>Pergunta para coment√°rios</li>
                <li>Incentivo ao compartilhamento</li>
                <li>Pr√≥ximo passo claro</li>
            </ul>
        </div>
    </div>
</div>

<h3 id="padroes-virais-identificados">üîç Padr√µes Virais Identificados</h3>
<div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Top 5 Formatos Virais</h4>
    <ol>
        <li><strong>Antes vs. Depois:</strong> Transforma√ß√µes visuais dram√°ticas</li>
        <li><strong>Listas Numeradas:</strong> "5 segredos que mudaram minha vida"</li>
        <li><strong>Hist√≥rias Pessoais:</strong> Vulnerabilidade aut√™ntica</li>
        <li><strong>Dicas Contraintuitivas:</strong> "Pare de fazer isso..."</li>
        <li><strong>Tend√™ncias Adaptadas:</strong> Formato viral + conte√∫do pr√≥prio</li>
    </ol>
</div>

<h3 id="calendario-viral">üìÖ Calend√°rio de Oportunidades Virais</h3>
<div style="background: #fff0f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Momentos de Alta Viraliza√ß√£o</h4>
    <ul>
        <li><strong>Segunda-feira (8h-10h):</strong> Motiva√ß√£o para a semana</li>
        <li><strong>Quarta-feira (12h-14h):</strong> Conte√∫do educativo</li>
        <li><strong>Sexta-feira (17h-19h):</strong> Entretenimento e inspira√ß√£o</li>
        <li><strong>Domingo (19h-21h):</strong> Reflex√µes e planejamento</li>
        <li><strong>Eventos Especiais:</strong> Datas comemorativas e trending topics</li>
    </ul>
</div>

<h3 id="estrategia-replicacao">üéØ Estrat√©gia de Replica√ß√£o</h3>
<div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h4>Como Replicar o Sucesso Viral</h4>
    <ol>
        <li><strong>Identificar Padr√µes:</strong> Analisar posts virais do nicho</li>
        <li><strong>Adaptar Formato:</strong> Usar estrutura comprovada com conte√∫do pr√≥prio</li>
        <li><strong>Testar Timing:</strong> Publicar nos hor√°rios de maior engajamento</li>
        <li><strong>Otimizar Visual:</strong> Usar elementos visuais impactantes</li>
        <li><strong>Monitorar e Amplificar:</strong> Impulsionar posts com tra√ß√£o inicial</li>
    </ol>
</div>
"""
    
    def _generate_generic_module_html(self, module: str) -> str:
        """Gera HTML gen√©rico para m√≥dulos n√£o espec√≠ficos"""
        
        module_title = module.replace('_', ' ').title()
        
        return f"""
<hr />
<h2 id="{module.lower()}">{module_title}</h2>
<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0;">
    <h4>‚ö†Ô∏è M√≥dulo em Desenvolvimento</h4>
    <p>O m√≥dulo <strong>{module_title}</strong> foi identificado como necess√°rio mas ainda n√£o foi implementado completamente.</p>
    <p><strong>Status:</strong> Aguardando dados espec√≠ficos da an√°lise</p>
    <p><em>Este m√≥dulo ser√° populado automaticamente quando os dados estiverem dispon√≠veis.</em></p>
</div>
"""
    
    def _improve_html_formatting(self, html_content: str) -> str:
        """Melhora a formata√ß√£o geral do HTML"""
        
        # Adiciona estilos CSS inline para melhor apresenta√ß√£o
        css_improvements = """
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; }
    h1, h2, h3, h4, h5 { color: #2c3e50; margin-top: 1.5em; }
    h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; }
    h2 { border-bottom: 2px solid #e74c3c; padding-bottom: 8px; }
    h3 { border-left: 4px solid #f39c12; padding-left: 15px; }
    .highlight { background: linear-gradient(120deg, #a8e6cf 0%, #dcedc1 100%); padding: 2px 6px; border-radius: 3px; }
    .metric { font-size: 1.2em; font-weight: bold; color: #27ae60; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; }
    .info { background: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 5px; }
    table { border-collapse: collapse; width: 100%; margin: 15px 0; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f8f9fa; font-weight: bold; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
</style>
"""
        
        # Insere CSS no in√≠cio do HTML
        if '<h1' in html_content:
            html_content = css_improvements + '\n' + html_content
        
        # Melhora formata√ß√£o de listas
        html_content = re.sub(r'<li><strong>(.*?):</strong>(.*?)</li>', 
                             r'<li><span class="highlight"><strong>\1:</strong></span>\2</li>', 
                             html_content)
        
        # Destaca m√©tricas num√©ricas
        html_content = re.sub(r'(\d+%|\d+\+|\d+x|R\$ [\d,]+)', 
                             r'<span class="metric">\1</span>', 
                             html_content)
        
        return html_content
    
    def _generate_detailed_md(self, html_content: str, raw_data: Dict[str, List[str]], session_dir: Path) -> str:
        """Gera arquivo MD detalhado com dados brutos preservados"""
        
        md_content = f"""# RELAT√ìRIO DETALHADO - DADOS COMPLETOS
**Gerado em:** {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}
**Sess√£o:** {session_dir.name}

---

## üìã SUM√ÅRIO EXECUTIVO

{self._extract_summary_from_html(html_content)}

---

## üîß DADOS T√âCNICOS PRESERVADOS

### üìä Blocos JSON Extra√≠dos
```json
{json.dumps(raw_data.get('json_blocks', []), indent=2, ensure_ascii=False)}
```

### üíª C√≥digo Extra√≠do
```python
{''.join(raw_data.get('code_blocks', []))}
```

### üêõ Logs de Debug
```
{''.join(raw_data.get('debug_logs', []))}
```

### üîó Chamadas de API
```
{''.join(raw_data.get('api_calls', []))}
```

### ‚öôÔ∏è Dados T√©cnicos
```
{''.join(raw_data.get('technical_data', []))}
```

---

## üìà AN√ÅLISE COMPLETA

{self._convert_html_to_md(html_content)}

---

## üîç METADADOS DA SESS√ÉO

- **Diret√≥rio:** {session_dir}
- **Arquivos Processados:** {len(list(session_dir.glob('*')))}
- **Timestamp de Sanitiza√ß√£o:** {datetime.now().isoformat()}
- **Dados Brutos Preservados:** {sum(len(v) for v in raw_data.values())} itens

---

*Este arquivo cont√©m todos os dados t√©cnicos e brutos removidos do relat√≥rio HTML final para melhor apresenta√ß√£o.*
"""
        
        return md_content
    
    def _extract_summary_from_html(self, html_content: str) -> str:
        """Extrai sum√°rio executivo do HTML"""
        
        # Procura por se√ß√£o de sum√°rio
        summary_match = re.search(r'<h2[^>]*>SUM√ÅRIO EXECUTIVO</h2>(.*?)(?=<h2|$)', html_content, re.DOTALL | re.IGNORECASE)
        
        if summary_match:
            summary_html = summary_match.group(1)
            # Converte HTML b√°sico para MD
            summary_md = re.sub(r'<p>(.*?)</p>', r'\1\n', summary_html)
            summary_md = re.sub(r'<strong>(.*?)</strong>', r'**\1**', summary_md)
            summary_md = re.sub(r'<em>(.*?)</em>', r'*\1*', summary_md)
            summary_md = re.sub(r'<[^>]+>', '', summary_md)  # Remove outras tags HTML
            return summary_md.strip()
        
        return "Sum√°rio executivo n√£o encontrado no relat√≥rio HTML."
    
    def _convert_html_to_md(self, html_content: str) -> str:
        """Converte HTML b√°sico para Markdown"""
        
        md_content = html_content
        
        # Converte headers
        md_content = re.sub(r'<h1[^>]*>(.*?)</h1>', r'# \1', md_content)
        md_content = re.sub(r'<h2[^>]*>(.*?)</h2>', r'## \1', md_content)
        md_content = re.sub(r'<h3[^>]*>(.*?)</h3>', r'### \1', md_content)
        md_content = re.sub(r'<h4[^>]*>(.*?)</h4>', r'#### \1', md_content)
        
        # Converte formata√ß√£o
        md_content = re.sub(r'<strong>(.*?)</strong>', r'**\1**', md_content)
        md_content = re.sub(r'<em>(.*?)</em>', r'*\1*', md_content)
        md_content = re.sub(r'<p>(.*?)</p>', r'\1\n', md_content)
        
        # Converte listas
        md_content = re.sub(r'<ul[^>]*>', '', md_content)
        md_content = re.sub(r'</ul>', '', md_content)
        md_content = re.sub(r'<ol[^>]*>', '', md_content)
        md_content = re.sub(r'</ol>', '', md_content)
        md_content = re.sub(r'<li[^>]*>(.*?)</li>', r'- \1', md_content)
        
        # Remove outras tags HTML
        md_content = re.sub(r'<[^>]+>', '', md_content)
        
        # Limpa espa√ßos excessivos
        md_content = re.sub(r'\n\s*\n\s*\n', '\n\n', md_content)
        
        return md_content.strip()
    
    def _generate_fallback_md(self) -> str:
        """Gera MD de fallback em caso de erro"""
        
        return f"""# RELAT√ìRIO DETALHADO - ERRO NA GERA√á√ÉO
**Gerado em:** {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}

## ‚ö†Ô∏è ERRO

Ocorreu um erro durante a sanitiza√ß√£o do relat√≥rio HTML. 
Os dados brutos n√£o puderam ser extra√≠dos adequadamente.

## üìã RECOMENDA√á√ïES

1. Verificar integridade do arquivo HTML original
2. Executar nova an√°lise se necess√°rio
3. Contatar suporte t√©cnico se o problema persistir

---

*Este √© um arquivo de fallback gerado automaticamente.*
"""

    def save_sanitized_reports(self, sanitized_html: str, detailed_md: str, session_dir: Path) -> Tuple[Path, Path]:
        """Salva os relat√≥rios sanitizados"""
        
        try:
            # Salva HTML sanitizado
            html_path = session_dir / "relatorio_final_sanitizado.html"
            with open(html_path, 'w', encoding='utf-8') as f:
                f.write(sanitized_html)
            
            # Salva MD detalhado
            md_path = session_dir / "relatorio_completo_detalhado.md"
            with open(md_path, 'w', encoding='utf-8') as f:
                f.write(detailed_md)
            
            logger.info(f"‚úÖ Relat√≥rios salvos: {html_path.name} e {md_path.name}")
            return html_path, md_path
            
        except Exception as e:
            logger.error(f"‚ùå Erro salvando relat√≥rios: {e}")
            return None, None